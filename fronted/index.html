<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人股票投资组合管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1rem; /* p-4 */
            margin-bottom: 1rem; /* mb-4 */
            height: 100%; /* Ensure cards take full height in grid cells */
            display: flex;
            flex-direction: column;
        }
        .card-content {
            flex-grow: 1; /* Allow content to grow and fill space */
            display: flex;
            flex-direction: column;
        }
        .chart-container {
            flex-grow: 1; /* Allow chart to take available space */
            position: relative;
            height: 100%; /* Ensure chart container fills parent height */
            min-height: 200px; /* Adjusted minimum height for charts */
        }
        .btn-primary {
            @apply bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 ease-in-out text-sm; /* Smaller text for buttons */
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300 transition duration-200 ease-in-out text-sm; /* Smaller text for buttons */
        }
        .input-field {
            @apply border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm; /* Smaller text for inputs */
        }
        /* Custom scrollbar for tables */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Adjust table cell padding for compactness */
        .min-w-full th, .min-w-full td {
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            padding-left: 0.75rem; /* px-3 */
            padding-right: 0.75rem; /* px-3 */
        }
    </style>
</head>
<body class="p-4"> <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">个人股票投资组合管理系统</h1> <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

            <div class="lg:col-span-1 flex flex-col gap-4">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">投资组合概览</h2> <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3"> <div class="bg-blue-50 p-3 rounded-lg shadow-sm">
                            <p class="text-xs text-gray-600">现金余额</p> <p id="cashBalance" class="text-xl font-bold text-blue-800 break-all">$0.00</p> </div>
                        <div class="bg-green-50 p-3 rounded-lg shadow-sm">
                            <p class="text-xs text-gray-600">总资产价值</p> <p id="totalValue" class="text-xl font-bold text-green-800 break-all">$0.00</p> </div>
                        <div class="bg-purple-50 p-3 rounded-lg shadow-sm">
                            <p class="text-xs text-gray-600">初始资金</p> <p id="initialCash" class="text-xl font-bold text-purple-800 break-all">$0.00</p> </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">投资占比</h3> <div class="chart-container">
                        <canvas id="investmentAllocationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col gap-4">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">股票详情与历史数据</h2> <div class="flex items-center space-x-3 mb-3"> <input type="text" id="stockSymbolInput" placeholder="输入股票代码 (如: AAPL)" class="input-field flex-grow">
                        <button id="fetchStockDataBtn" class="btn-primary">查询</button> </div>

                    <div id="currentStockInfo" class="mb-3 bg-gray-50 p-3 rounded-lg shadow-sm hidden">
                        <p class="text-base font-semibold text-gray-800 mb-1" id="currentStockName"></p> <div class="flex flex-wrap items-baseline gap-x-3 gap-y-1 mb-1">
                            <p class="text-xl font-bold text-gray-900" id="currentStockPrice"></p>
                            <p class="text-sm text-gray-600" id="currentStockChange"></p>
                        </div>
                        <div class="flex flex-wrap items-baseline gap-x-3 gap-y-1 text-xs"> <p class="text-gray-600" id="currentStockVolume"></p>
                            <p class="text-gray-600" id="currentMarketStatus"></p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2">历史价格走势</h3> <div class="flex space-x-2 mb-3">
                        <button id="history7DaysBtn" class="btn-secondary">近7天</button>
                        <button id="history1MonthBtn" class="btn-secondary">近1月</button>
                        <button id="history2MonthsBtn" class="btn-secondary">近2月</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="stockHistoricalChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col gap-4">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">交易股票</h2> <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label for="tradeSymbol" class="block text-xs font-medium text-gray-700 mb-1">股票代码</label> <input type="text" id="tradeSymbol" placeholder="如: AAPL" class="input-field w-full">
                        </div>
                        <div>
                            <label for="tradeQuantity" class="block text-xs font-medium text-gray-700 mb-1">数量</label> <input type="number" id="tradeQuantity" placeholder="数量" class="input-field w-full min-w-0">
                        </div>
                        <div class="md:col-span-2">
                            <label for="tradePrice" class="block text-xs font-medium text-gray-700 mb-1">价格 (当前价格)</label> <input type="number" id="tradePrice" placeholder="价格" step="0.01" class="input-field w-full min-w-0">
                        </div>
                    </div>
                    <div class="flex space-x-3"> <button id="buyStockBtn" class="btn-primary flex-grow">买入</button>
                        <button id="sellStockBtn" class="btn-primary flex-grow bg-red-600 hover:bg-red-700">卖出</button>
                    </div>
                    <p id="tradeMessage" class="mt-3 text-center text-xs font-medium"></p> </div>

                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">交易历史 (最新10笔)</h2> <div class="overflow-x-auto flex-grow">
                        <table class="min-w-full bg-white rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100 text-left text-gray-600 uppercase text-xs leading-normal"> <th class="py-2 px-3">交易日期</th>
                                    <th class="py-2 px-3">股票代码</th>
                                    <th class="py-2 px-3">类型</th>
                                    <th class="py-2 px-3">数量</th>
                                    <th class="py-2 px-3">价格</th>
                                </tr>
                            </thead>
                            <tbody id="transactionHistoryTableBody" class="text-gray-700 text-xs font-light"> </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div> <div class="card mt-4"> <h3 class="text-xl font-semibold text-gray-700 mb-3">股票持仓</h3> <div class="overflow-x-auto flex-grow">
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-100 text-left text-gray-600 uppercase text-xs leading-normal"> <th class="py-2 px-3">股票代码</th>
                            <th class="py-2 px-3">数量</th>
                            <th class="py-2 px-3">购买价格</th>
                            <th class="py-2 px-3">当前价格</th>
                            <th class="py-2 px-3">市值</th>
                            <th class="py-2 px-3">盈亏</th>
                        </tr>
                    </thead>
                    <tbody id="stockHoldingsTableBody" class="text-gray-700 text-xs font-light"> </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Base URL for API calls
        const API_BASE_URL = 'http://localhost:3000/api';

        // Chart instances
        let stockHistoricalChart;
        let investmentAllocationChart;
        // let portfolioTrendChart; // Removed as per user request

        // Utility function to format currency
        const formatCurrency = (value) => {
            // Ensure value is a number before formatting, by stripping non-numeric characters (except decimal and sign)
            const numValue = parseFloat(String(value).replace(/[^0-9.-]+/g,""));
            if (isNaN(numValue)) return value; // Return original if not a valid number
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(numValue);
        };

        // Utility function to format date
        const formatDate = (dateString) => {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('zh-CN', options);
        };

        // --- Portfolio Functions ---

        // Initializes the portfolio if it doesn't exist
        async function initializePortfolio() {
            try {
                const response = await fetch(`${API_BASE_URL}/portfolio/initialize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ initialCash: 10000.00 }), // Default initial cash
                });
                const data = await response.json();
                if (!response.ok) {
                    // If portfolio already exists, the backend might return 500 or specific message
                    // We can choose to ignore if it's an "already initialized" error
                    if (data.message && data.message.includes('already initialized')) {
                        console.warn('Portfolio already initialized.');
                    } else {
                        throw new Error(data.message || 'Failed to initialize portfolio');
                    }
                } else {
                    console.log('Portfolio initialized:', data);
                }
            } catch (error) {
                console.error('Error initializing portfolio:', error);
                // Do not throw, as it might already be initialized from a previous run
            }
        }


        // Fetches and displays portfolio overview
        async function fetchPortfolioOverview() {
            try {
                const response = await fetch(`${API_BASE_URL}/portfolio`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('cashBalance').textContent = formatCurrency(data.cash_balance);
                    document.getElementById('totalValue').textContent = formatCurrency(data.total_value);
                    document.getElementById('initialCash').textContent = formatCurrency(data.initial_cash);

                    // Update stock holdings table
                    const holdingsTableBody = document.getElementById('stockHoldingsTableBody');
                    holdingsTableBody.innerHTML = ''; // Clear previous data
                    if (data.holdings && data.holdings.length > 0) {
                        data.holdings.forEach(holding => {
                            const row = holdingsTableBody.insertRow();
                            row.className = 'border-b border-gray-200 hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="py-2 px-3 text-left font-medium">${holding.symbol}</td>
                                <td class="py-2 px-3 text-left">${holding.quantity}</td>
                                <td class="py-2 px-3 text-left">${formatCurrency(holding.purchasePrice)}</td>
                                <td class="py-2 px-3 text-left">${formatCurrency(holding.currentPrice)}</td>
                                <td class="py-2 px-3 text-left">${formatCurrency(holding.marketValue)}</td>
                                <td class="py-2 px-3 text-left ${holding.profit_loss >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(holding.profit_loss)}</td>
                            `;
                        });
                    } else {
                        holdingsTableBody.innerHTML = `<tr><td colspan="6" class="py-2 px-3 text-center text-gray-500">暂无持仓股票</td></tr>`;
                    }

                    // Render investment allocation pie chart
                    renderInvestmentAllocationChart(data.investmentAllocation);
                } else {
                    console.error('Error fetching portfolio:', data.message);
                    // If portfolio not found, try to initialize it
                    if (response.status === 404) {
                        await initializePortfolio();
                        await fetchPortfolioOverview(); // Try fetching again after initialization
                    }
                }
            } catch (error) {
                console.error('Error fetching portfolio overview:', error);
            }
        }

        // Renders the investment allocation pie chart
        function renderInvestmentAllocationChart(allocationData) {
            const ctx = document.getElementById('investmentAllocationChart').getContext('2d');

            // Destroy existing chart if it exists
            if (investmentAllocationChart) {
                investmentAllocationChart.destroy();
            }

            console.log('Investment Allocation Data received:', allocationData); // Debug log

            if (!allocationData || allocationData.length === 0 || allocationData.every(item => item.value === 0)) {
                console.warn('No valid investment allocation data to display for the pie chart.');
                // Display a message on the canvas itself
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280'; // gray-500
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle'; // Center vertically
                ctx.fillText('暂无投资占比数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return; // Exit if no data
            }

            const labels = allocationData.map(item => item.symbol);
            const values = allocationData.map(item => item.value);
            const percentages = allocationData.map(item => item.percentage.toFixed(2) + '%');

            // Generate a consistent set of colors
            const backgroundColors = [
                '#4299E1', '#667EEA', '#805AD5', '#D53F8C', '#DD6B20', '#38B2AC', '#48BB78', '#ECC94B', '#ED8936', '#9F7AEA'
            ];
            const borderColors = [
                '#3182CE', '#5A67D8', '#6B46C1', '#B83280', '#C05621', '#2C7A7B', '#38A169', '#D69E2E', '#D97706', '#805AD5'
            ];

            investmentAllocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed) + ' (' + percentages[context.dataIndex] + ')';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                return percentages[context.dataIndex];
                            },
                            font: {
                                weight: 'bold',
                                size: 12
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels] // Register the datalabels plugin
            });
        }

        // Removed fetchPortfolioTrend and renderPortfolioTrendChart as per user request
        // function fetchPortfolioTrend(days = 7) { ... }
        // function renderPortfolioTrendChart(trendData) { ... }

        // --- Stock Data Functions ---

        // Fetches and displays current stock data and historical data
        async function fetchStockData(symbol, historyDays = 30) {
            if (!symbol) {
                alert('请输入股票代码！');
                return;
            }

            const currentStockInfoDiv = document.getElementById('currentStockInfo');
            const currentStockName = document.getElementById('currentStockName');
            const currentStockPrice = document.getElementById('currentStockPrice');
            const currentStockChange = document.getElementById('currentStockChange');
            const currentStockVolume = document.getElementById('currentStockVolume');
            const currentMarketStatus = document.getElementById('currentMarketStatus');


            try {
                // Fetch current data
                console.log(`Fetching real-time data for: ${symbol}`);
                const currentResponse = await fetch(`${API_BASE_URL}/real-time/${symbol}`);
                console.log('Real-time API Response:', currentResponse); // Log raw response
                const currentData = await currentResponse.json();
                console.log('Real-time API Data:', currentData); // Log parsed data

                let dataToDisplay = {}; // Initialize to an empty object

                // --- MODIFIED LOGIC START ---
                if (currentData && currentData.primaryData && Object.keys(currentData.primaryData).length > 0) {
                    // Prefer primaryData if it exists and is not empty, regardless of isRealTime flag
                    dataToDisplay = currentData.primaryData;
                } else if (currentData && currentData.secondaryData && Object.keys(currentData.secondaryData).length > 0) {
                    // Fallback to secondaryData if primaryData is not available/empty
                    dataToDisplay = currentData.secondaryData;
                }
                // --- MODIFIED LOGIC END ---


                if (currentResponse.ok && Object.keys(dataToDisplay).length > 0) { // Check if dataToDisplay has properties
                    currentStockInfoDiv.classList.remove('hidden');

                    currentStockName.textContent = currentData.companyName || currentData.symbol || 'N/A';
                    currentStockPrice.textContent = dataToDisplay.lastSalePrice ? formatCurrency(dataToDisplay.lastSalePrice) : 'N/A';

                    const netChangeNum = parseFloat(dataToDisplay.netChange);
                    const changeClass = netChangeNum > 0 ? 'text-green-600' : (netChangeNum < 0 ? 'text-red-600' : 'text-gray-600');

                    currentStockChange.textContent = `变化: ${dataToDisplay.netChange || 'N/A'} (${dataToDisplay.percentageChange || 'N/A'})`;
                    currentStockChange.className = `text-sm ${changeClass}`;

                    currentStockVolume.textContent = `成交量: ${dataToDisplay.volume || 'N/A'}`;
                    currentMarketStatus.textContent = `市场状态: ${currentData.marketStatus || 'N/A'}`;


                    // Auto-fill trade price
                    const tradePriceValue = dataToDisplay.lastSalePrice ? parseFloat(String(dataToDisplay.lastSalePrice).replace(/[^0-9.-]+/g,"")) : '';
                    document.getElementById('tradeSymbol').value = symbol;
                    document.getElementById('tradePrice').value = tradePriceValue;

                } else {
                    currentStockInfoDiv.classList.add('hidden');
                    console.error('Error fetching current stock data: No valid data to display or API response not OK.', currentData.message || 'Unknown error', 'Data received:', currentData);
                    alert(`无法获取 ${symbol} 的实时数据。`);
                }

                // Fetch historical data
                console.log(`Fetching historical data for: ${symbol}`);
                const historicalResponse = await fetch(`${API_BASE_URL}/historical/${symbol}`);
                console.log('Historical API Response:', historicalResponse);
                const historicalData = await historicalResponse.json();
                console.log('Historical API Data:', historicalData);

                if (historicalResponse.ok && historicalData && historicalData.length > 0) {
                    renderStockHistoricalChart(historicalData, symbol);
                } else {
                    console.error('Error fetching historical stock data:', historicalData.message || 'Unknown error');
                    alert(`无法获取 ${symbol} 的历史数据。`);
                }

            } catch (error) {
                console.error('Error fetching stock data:', error);
                alert('获取股票数据时发生错误。请检查股票代码或稍后再试。');
            }
        }

        // Renders the stock historical line chart
        function renderStockHistoricalChart(prices, symbol) {
            const ctx = document.getElementById('stockHistoricalChart').getContext('2d');

            // Destroy existing chart if it exists
            if (stockHistoricalChart) {
                stockHistoricalChart.destroy();
            }

            // Filter out data points with null or zero closing prices and ensure timestamp_unix exists
            const validPrices = prices.filter(p => p.close !== null && p.close !== 0 && p.timestamp_unix);

            // Sort data by timestamp_unix to ensure correct line chart rendering
            const sortedPrices = validPrices.sort((a, b) => a.timestamp_unix - b.timestamp_unix);

            const labels = sortedPrices.map(p => formatDate(new Date(p.timestamp_unix * 1000))); // Convert Unix timestamp (seconds) to Date
            const data = sortedPrices.map(p => p.close);

            stockHistoricalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${symbol} 历史价格`,
                        data: data,
                        borderColor: '#10B981', // Green-500
                        backgroundColor: 'rgba(16, 185, 129, 0.1)', // Light green
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#10B981',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '价格'
                            },
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Trade Functions ---

        // Handles buying stock
        async function buyStock() {
            const symbol = document.getElementById('tradeSymbol').value.toUpperCase();
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            const price = parseFloat(document.getElementById('tradePrice').value);
            const tradeMessage = document.getElementById('tradeMessage');

            if (!symbol || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
                tradeMessage.textContent = '请输入有效的股票代码、数量和价格。';
                tradeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/portfolio/buy`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol, quantity, price }),
                });
                const data = await response.json();

                if (response.ok) {
                    tradeMessage.textContent = `成功买入 ${quantity} 股 ${symbol}，新现金余额: ${formatCurrency(data.newCashBalance)}`;
                    tradeMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';
                    // Refresh portfolio and transactions
                    fetchPortfolioOverview();
                    fetchTransactionsHistory();
                } else {
                    tradeMessage.textContent = `买入失败: ${data.message || '未知错误'}`;
                    tradeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error buying stock:', error);
                tradeMessage.textContent = '买入股票时发生错误。';
                tradeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
            }
        }

        // Handles selling stock
        async function sellStock() {
            const symbol = document.getElementById('tradeSymbol').value.toUpperCase();
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            const price = parseFloat(document.getElementById('tradePrice').value);
            const tradeMessage = document.getElementById('tradeMessage');

            if (!symbol || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
                tradeMessage.textContent = '请输入有效的股票代码、数量和价格。';
                tradeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/portfolio/sell`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol, quantity, price }),
                });
                const data = await response.json();

                if (response.ok) {
                    tradeMessage.textContent = `成功卖出 ${quantity} 股 ${symbol}，新现金余额: ${formatCurrency(data.newCashBalance)}`;
                    tradeMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';
                    // Refresh portfolio and transactions
                    fetchPortfolioOverview();
                    fetchTransactionsHistory();
                } else {
                    tradeMessage.textContent = `卖出失败: ${data.message || '未知错误'}`;
                    tradeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error selling stock:', error);
                tradeMessage.textContent = '卖出股票时发生错误。';
                tradeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
            }
        }

        // Fetches and displays transaction history
        async function fetchTransactionsHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/portfolio/transactions`);
                const data = await response.json();

                const transactionHistoryTableBody = document.getElementById('transactionHistoryTableBody');
                transactionHistoryTableBody.innerHTML = ''; // Clear previous data

                if (response.ok && data && data.length > 0) {
                    // Limit to the latest 10 transactions
                    const latestTransactions = data.slice(0, 10);
                    latestTransactions.forEach(transaction => {
                        const row = transactionHistoryTableBody.insertRow();
                        row.className = 'border-b border-gray-200 hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="py-2 px-3 text-left">${formatDate(transaction.transaction_date)}</td>
                            <td class="py-2 px-3 text-left">${transaction.symbol}</td>
                            <td class="py-2 px-3 text-left ${transaction.type === 'buy' ? 'text-red-600' : 'text-green-600'}">${transaction.type === 'buy' ? '买入' : '卖出'}</td>
                            <td class="py-2 px-3 text-left">${transaction.quantity}</td>
                            <td class="py-2 px-3 text-left">${formatCurrency(transaction.price)}</td>
                        `;
                    });
                } else {
                    transactionHistoryTableBody.innerHTML = `<tr><td colspan="5" class="py-2 px-3 text-center text-gray-500">暂无交易记录</td></tr>`;
                }
            } catch (error) {
                console.error('Error fetching transaction history:', error);
            }
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize portfolio on page load (if not already)
            await initializePortfolio();
            // Fetch initial data
            fetchPortfolioOverview();
            fetchTransactionsHistory();
            // fetchPortfolioTrend(7); // Removed as per user request

            // Stock Data Section
            document.getElementById('fetchStockDataBtn').addEventListener('click', () => {
                const symbol = document.getElementById('stockSymbolInput').value.toUpperCase();
                fetchStockData(symbol, 30); // Default to 30 days for historical data
            });

            document.getElementById('stockSymbolInput').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    document.getElementById('fetchStockDataBtn').click();
                }
            });

            // Historical data buttons
            document.getElementById('history7DaysBtn').addEventListener('click', () => {
                const symbol = document.getElementById('stockSymbolInput').value.toUpperCase();
                // Note: Backend currently only supports 'limit: 30' for historical data,
                // so these buttons will all fetch the same 30-day data for now.
                // In a real app, you'd adjust the 'limit' parameter based on the button clicked.
                fetchStockData(symbol, 7);
            });
            document.getElementById('history1MonthBtn').addEventListener('click', () => {
                const symbol = document.getElementById('stockSymbolInput').value.toUpperCase();
                fetchStockData(symbol, 30);
            });
            document.getElementById('history2MonthsBtn').addEventListener('click', () => {
                const symbol = document.getElementById('stockSymbolInput').value.toUpperCase();
                fetchStockData(symbol, 60);
            });


            // Portfolio Trend Section buttons are removed from HTML, but keeping functions for now if needed elsewhere
            // document.getElementById('trend7DaysBtn').addEventListener('click', () => fetchPortfolioTrend(7));
            // document.getElementById('trend1MonthBtn').addEventListener('click', () => fetchPortfolioTrend(30));
            // document.getElementById('trend2MonthsBtn').addEventListener('click', () => fetchPortfolioTrend(60));


            // Buy/Sell Stock Section
            document.getElementById('buyStockBtn').addEventListener('click', buyStock);
            document.getElementById('sellStockBtn').addEventListener('click', sellStock);

            // Fetch a default stock data on load for immediate display
            fetchStockData('AAPL', 30); // Example: Apple Inc.
        });
    </script>
</body>
</html>
